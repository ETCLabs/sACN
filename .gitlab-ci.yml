workflow:
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

variables:
  GIT_STRATEGY: clone
  GIT_SUBMODULE_STRATEGY: normal
  GLOBAL_CMAKE_OPTIONS: -DSACN_BUILD_TESTS=ON

linux-build:
  stage: build
  tags:
    - etc-linux-docker
  image: etc-docker.artifactory.etcconnect.com/etc/common-tech/gcc-cmake:latest
  parallel:
    matrix:
      - SANITIZER_DEFS:
          - -DSACN_ENABLE_TSAN=ON
  script:
    - mkdir build
    - cd build
    - cmake ${GLOBAL_CMAKE_OPTIONS} ${SANITIZER_DEFS} ..
    - cmake --build .
    - ctest --output-on-failure
  artifacts:
    when: always
    reports:
      junit: build/tests/unit/test-results/*.xml
